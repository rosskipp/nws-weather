<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Weather Forecast</title>
<meta name="theme-color" content="#0f1923">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="manifest" href="manifest.json">
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üå§</text></svg>">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#0f1923;--card:#162230;--card2:#1a2a3a;--accent:#4fc3f7;--accent2:#81d4fa;--text:#e0e6ed;--text2:#8899aa;--green:#66bb6a;--orange:#ffa726;--red:#ef5350;--purple:#ab47bc;--border:#1e3347;--radius:16px}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--text);min-height:100vh;-webkit-font-smoothing:antialiased}
.container{max-width:900px;margin:0 auto;padding:16px}
header{text-align:center;padding:20px 0 10px}
header h1{font-size:1.4rem;font-weight:600;color:var(--accent)}
.search-box{position:relative;margin:16px auto;max-width:500px}
.search-box input{width:100%;padding:14px 20px 14px 44px;background:var(--card);border:1px solid var(--border);border-radius:50px;color:var(--text);font-size:1rem;outline:none;transition:border-color .2s}
.search-box input:focus{border-color:var(--accent)}
.search-box svg{position:absolute;left:16px;top:50%;transform:translateY(-50%);width:18px;height:18px;fill:var(--text2)}
.search-results{position:absolute;top:100%;left:0;right:0;background:var(--card);border:1px solid var(--border);border-radius:var(--radius);margin-top:4px;z-index:100;overflow:hidden;display:none}
.search-results.active{display:block}
.search-results div{padding:12px 20px;cursor:pointer;font-size:.9rem;border-bottom:1px solid var(--border);transition:background .15s}
.search-results div:hover{background:var(--card2)}
.search-results div:last-child{border-bottom:none}
.location-name{text-align:center;font-size:1.1rem;color:var(--text2);margin-bottom:20px}
.current{background:linear-gradient(135deg,#1a3a5c,#162230);border-radius:var(--radius);padding:28px;margin-bottom:20px;text-align:center;border:1px solid var(--border)}
.current .temp{font-size:4rem;font-weight:700;background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;line-height:1.1}
.current .desc{font-size:1.15rem;color:var(--text2);margin:8px 0}
.current .details{display:flex;justify-content:center;gap:24px;margin-top:16px;flex-wrap:wrap}
.current .details span{font-size:.85rem;color:var(--text2)}
.current .details span b{color:var(--text);font-weight:500}
.section-title{font-size:1.1rem;font-weight:600;margin:24px 0 12px;color:var(--text);display:flex;align-items:center;gap:8px}
.section-title span{font-size:1.2rem}
.chart-card{background:var(--card);border-radius:var(--radius);padding:16px;margin-bottom:16px;border:1px solid var(--border)}
.chart-card h3{font-size:.85rem;color:var(--text2);margin-bottom:12px;font-weight:500;text-transform:uppercase;letter-spacing:.5px}
.chart-card canvas{width:100%!important}
.forecast-cards{display:grid;gap:10px}
.forecast-card{background:var(--card);border-radius:var(--radius);padding:16px 20px;border:1px solid var(--border);display:flex;align-items:center;gap:16px}
.forecast-card .period-name{font-weight:600;min-width:110px;font-size:.9rem}
.forecast-card .period-temp{font-size:1.3rem;font-weight:700;min-width:55px;text-align:right}
.forecast-card .period-temp.hot{color:var(--orange)}
.forecast-card .period-temp.cold{color:var(--accent)}
.forecast-card .period-detail{font-size:.82rem;color:var(--text2);flex:1}
.loading{text-align:center;padding:60px 20px;color:var(--text2)}
.loading .spinner{width:36px;height:36px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite;margin:0 auto 16px}
@keyframes spin{to{transform:rotate(360deg)}}
.error{text-align:center;padding:40px;color:var(--red);background:var(--card);border-radius:var(--radius);border:1px solid #3a1a1a}
.tabs{display:flex;gap:6px;margin-bottom:16px;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none}
.tabs::-webkit-scrollbar{display:none}
.tab{padding:8px 18px;border-radius:50px;background:var(--card);border:1px solid var(--border);color:var(--text2);font-size:.82rem;cursor:pointer;white-space:nowrap;transition:all .2s;font-weight:500}
.tab.active{background:var(--accent);color:var(--bg);border-color:var(--accent)}
.updated{text-align:center;font-size:.75rem;color:var(--text2);margin-top:20px;padding-bottom:20px}
@media(max-width:600px){
  .current .temp{font-size:3rem}
  .current .details{gap:16px}
  .forecast-card{flex-wrap:wrap;gap:8px}
  .forecast-card .period-name{min-width:auto}
}
</style>
</head>
<body>
<div class="container">
  <header>
    <h1>‚õÖ Weather Forecast</h1>
  </header>
  <div class="search-box">
    <svg viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27A6.47 6.47 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
    <input type="text" id="searchInput" placeholder="Search city or address..." autocomplete="off">
    <div class="search-results" id="searchResults"></div>
  </div>
  <div id="app">
    <div class="loading"><div class="spinner"></div>Loading forecast‚Ä¶</div>
  </div>
  <div class="updated" id="updated"></div>
</div>

<script>
const API='https://api.weather.gov';
const UA={'User-Agent':'NWSWeatherApp/1.0 (ross@openclaw.dev)'};
const DEFAULT_LAT=39.9239,DEFAULT_LON=-105.0886;
let charts={};

async function nws(url){
  const r=await fetch(url,{headers:UA});
  if(!r.ok) throw new Error(`NWS API error: ${r.status}`);
  return r.json();
}

async function loadWeather(lat,lon){
  const app=document.getElementById('app');
  app.innerHTML='<div class="loading"><div class="spinner"></div>Loading forecast‚Ä¶</div>';
  try{
    const points=await nws(`${API}/points/${lat.toFixed(4)},${lon.toFixed(4)}`);
    const p=points.properties;
    const locName=`${p.relativeLocation.properties.city}, ${p.relativeLocation.properties.state}`;
    const [hourly,forecast]=await Promise.all([
      nws(p.forecastHourly),
      nws(p.forecast)
    ]);
    render(locName,hourly.properties.periods,forecast.properties.periods);
    document.getElementById('updated').textContent=`Updated ${new Date().toLocaleTimeString()}`;
  }catch(e){
    app.innerHTML=`<div class="error">‚ö†Ô∏è ${e.message}<br><small>Try again or search a different location</small></div>`;
  }
}

function render(location,hourly,periods){
  const now=hourly[0];
  const h=hourly.slice(0,72);
  const app=document.getElementById('app');
  
  // Wind direction arrow
  const windDir=now.windDirection;
  
  app.innerHTML=`
    <div class="location-name">üìç ${location}</div>
    <div class="current">
      <div class="temp">${now.temperature}¬∞F</div>
      <div class="desc">${now.shortForecast}</div>
      <div class="details">
        <span>üí® Wind <b>${now.windSpeed} ${windDir}</b></span>
        <span>üíß Humidity <b>${now.relativeHumidity?.value??'--'}%</b></span>
        <span>üåß Precip <b>${now.probabilityOfPrecipitation?.value??0}%</b></span>
      </div>
    </div>
    
    <div class="section-title"><span>üìä</span> Hourly Charts</div>
    <div class="tabs" id="chartTabs">
      <div class="tab active" data-chart="temp">Temperature</div>
      <div class="tab" data-chart="precip">Precipitation</div>
      <div class="tab" data-chart="wind">Wind</div>
      <div class="tab" data-chart="humidity">Humidity</div>
    </div>
    <div class="chart-card">
      <canvas id="chart" height="200"></canvas>
    </div>
    
    <div class="section-title"><span>üìã</span> Extended Forecast</div>
    <div class="forecast-cards" id="forecastCards"></div>
  `;
  
  // Forecast cards
  const fc=document.getElementById('forecastCards');
  periods.slice(0,14).forEach(p=>{
    const isNight=!p.isDaytime;
    const cls=p.temperature>80?'hot':p.temperature<40?'cold':'';
    fc.innerHTML+=`<div class="forecast-card">
      <div class="period-name">${isNight?'üåô':'‚òÄÔ∏è'} ${p.name}</div>
      <div class="period-temp ${cls}">${p.temperature}¬∞</div>
      <div class="period-detail">${p.shortForecast} ¬∑ Wind ${p.windSpeed} ${p.windDirection}</div>
    </div>`;
  });
  
  // Chart data
  const labels=h.map(p=>{
    const d=new Date(p.startTime);
    return d.toLocaleDateString('en-US',{weekday:'short'})+' '+d.toLocaleTimeString('en-US',{hour:'numeric'});
  });
  const datasets={
    temp:{label:'Temperature (¬∞F)',data:h.map(p=>p.temperature),color:'#4fc3f7',fill:true},
    precip:{label:'Precipitation (%)',data:h.map(p=>p.probabilityOfPrecipitation?.value??0),color:'#66bb6a',fill:true},
    wind:{label:'Wind Speed (mph)',data:h.map(p=>parseInt(p.windSpeed)),color:'#ffa726',fill:false},
    humidity:{label:'Humidity (%)',data:h.map(p=>p.relativeHumidity?.value??0),color:'#ab47bc',fill:true}
  };
  
  let currentChart='temp';
  
  function drawChart(key){
    const ds=datasets[key];
    if(charts.main) charts.main.destroy();
    const ctx=document.getElementById('chart').getContext('2d');
    const gradient=ctx.createLinearGradient(0,0,0,200);
    gradient.addColorStop(0,ds.color+'40');
    gradient.addColorStop(1,ds.color+'05');
    charts.main=new Chart(ctx,{
      type:'line',
      data:{labels,datasets:[{
        label:ds.label,data:ds.data,
        borderColor:ds.color,backgroundColor:ds.fill?gradient:'transparent',
        borderWidth:2,pointRadius:0,pointHitRadius:10,
        tension:.4,fill:ds.fill
      }]},
      options:{
        responsive:true,maintainAspectRatio:false,
        interaction:{intersect:false,mode:'index'},
        plugins:{legend:{display:false},tooltip:{
          backgroundColor:'#1a2a3a',titleColor:'#8899aa',bodyColor:'#e0e6ed',
          borderColor:'#1e3347',borderWidth:1,padding:10,
          displayColors:false,
          callbacks:{label:i=>` ${i.parsed.y} ${key==='temp'?'¬∞F':key==='wind'?'mph':'%'}`}
        }},
        scales:{
          x:{ticks:{color:'#556677',maxRotation:0,autoSkip:true,maxTicksLimit:8,font:{size:11}},grid:{color:'#1e334730'}},
          y:{ticks:{color:'#556677',font:{size:11}},grid:{color:'#1e334730'}}
        }
      }
    });
  }
  
  drawChart('temp');
  
  document.getElementById('chartTabs').addEventListener('click',e=>{
    const tab=e.target.closest('.tab');
    if(!tab)return;
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    tab.classList.add('active');
    drawChart(tab.dataset.chart);
  });
}

// Search
let searchTimeout;
const searchInput=document.getElementById('searchInput');
const searchResults=document.getElementById('searchResults');

searchInput.addEventListener('input',()=>{
  clearTimeout(searchTimeout);
  const q=searchInput.value.trim();
  if(q.length<3){searchResults.classList.remove('active');return;}
  searchTimeout=setTimeout(async()=>{
    try{
      const r=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&limit=5&countrycodes=us`);
      const data=await r.json();
      if(!data.length){searchResults.classList.remove('active');return;}
      searchResults.innerHTML=data.map(d=>`<div data-lat="${d.lat}" data-lon="${d.lon}">${d.display_name}</div>`).join('');
      searchResults.classList.add('active');
    }catch(e){}
  },400);
});

searchResults.addEventListener('click',e=>{
  const el=e.target.closest('div[data-lat]');
  if(!el)return;
  searchResults.classList.remove('active');
  searchInput.value='';
  loadWeather(parseFloat(el.dataset.lat),parseFloat(el.dataset.lon));
});

document.addEventListener('click',e=>{
  if(!e.target.closest('.search-box'))searchResults.classList.remove('active');
});

// Init
loadWeather(DEFAULT_LAT,DEFAULT_LON);

// PWA
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('sw.js').catch(()=>{});
}
</script>
</body>
</html>
